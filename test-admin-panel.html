<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel Test - Pakistani Tax Advisor</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        .login-section { background: #f9f9f9; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .users-section { margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; font-weight: bold; }
        tr:hover { background-color: #f5f5f5; }
        .btn { padding: 8px 15px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn:hover { opacity: 0.8; }
        .status { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .status-active { background: #d4edda; color: #155724; }
        .status-inactive { background: #f8d7da; color: #721c24; }
        .role { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .role-user { background: #cce7ff; color: #0066cc; }
        .role-admin { background: #e6ccff; color: #6600cc; }
        .role-super_admin { background: #ffcccc; color: #cc0000; }
        .form-group { margin: 10px 0; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; margin: 10% auto; padding: 20px; width: 90%; max-width: 500px; border-radius: 8px; }
        .close { float: right; font-size: 24px; cursor: pointer; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 5px; text-align: center; }
        .stat-number { font-size: 24px; font-weight: bold; color: #007bff; }
        .search-bar { margin: 15px 0; }
        .search-bar input { width: 300px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .checkbox { margin-right: 10px; }
        .selected { background-color: #e3f2fd !important; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üáµüá∞ Pakistani Tax Advisor - Admin Panel Test</h1>
            <p>Testing all admin functionality including user management, bulk operations, and real database integration</p>
        </div>

        <!-- Login Section -->
        <div class="login-section">
            <h3>üîê Admin Login</h3>
            <div style="display: flex; gap: 15px; align-items: end;">
                <div>
                    <label>Email:</label>
                    <input type="email" id="email" value="superadmin@paktaxadvisor.com" style="width: 250px;">
                </div>
                <div>
                    <label>Password:</label>
                    <input type="password" id="password" value="superadmin123" style="width: 150px;">
                </div>
                <button class="btn btn-primary" onclick="login()">Login</button>
                <button class="btn btn-warning" onclick="logout()">Logout</button>
            </div>
            <div style="margin-top: 10px;">
                <strong>Quick Test Accounts:</strong><br>
                <button class="btn" onclick="fillTestAccount(testAccounts[0])" style="font-size: 12px; padding: 4px 8px;">Super Admin</button>
                <button class="btn" onclick="fillTestAccount(testAccounts[1])" style="font-size: 12px; padding: 4px 8px;">Admin</button>
                <button class="btn" onclick="fillTestAccount(testAccounts[2])" style="font-size: 12px; padding: 4px 8px;">Test User</button>
            </div>
            <div id="loginStatus" style="margin-top: 10px; font-weight: bold;"></div>
        </div>

        <!-- Stats Section -->
        <div class="stats" id="statsSection" style="display: none;">
            <div class="stat-card">
                <div class="stat-number" id="totalUsers">0</div>
                <div>Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeUsers">0</div>
                <div>Active Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="adminUsers">0</div>
                <div>Admin Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="newUsers">0</div>
                <div>New This Month</div>
            </div>
        </div>

        <!-- User Management Section -->
        <div class="users-section" id="usersSection" style="display: none;">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                <h3>üë• User Management</h3>
                <div>
                    <button class="btn btn-success" onclick="showAddUserModal()">‚ûï Add User</button>
                    <button class="btn btn-danger" onclick="bulkDelete()" id="bulkDeleteBtn" style="display: none;">üóëÔ∏è Delete Selected</button>
                </div>
            </div>
            
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Search users..." onkeyup="filterUsers()">
                <select id="roleFilter" onchange="filterUsers()">
                    <option value="all">All Roles</option>
                    <option value="user">Users</option>
                    <option value="admin">Admins</option>
                    <option value="super_admin">Super Admins</option>
                </select>
                <select id="statusFilter" onchange="filterUsers()">
                    <option value="all">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
            </div>

            <table id="usersTable">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                        <th>User</th>
                        <th>Type</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                </tbody>
            </table>
        </div>

        <!-- Add User Modal -->
        <div id="addUserModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeAddUserModal()">&times;</span>
                <h3>Add New User</h3>
                <form id="addUserForm">
                    <div class="form-group">
                        <label>Name:</label>
                        <input type="text" id="newName" required>
                    </div>
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" id="newEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Password:</label>
                        <input type="password" id="newPassword" required>
                    </div>
                    <div class="form-group">
                        <label>Role:</label>
                        <select id="newRole">
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>User Type:</label>
                        <select id="newUserType">
                            <option value="individual">Individual</option>
                            <option value="business">Business</option>
                        </select>
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" class="btn" onclick="closeAddUserModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let authToken = null;
        let allUsers = [];
        let selectedUsers = [];

        // Quick test accounts
        const testAccounts = [
            { name: 'Super Admin', email: 'superadmin@paktaxadvisor.com', password: 'superadmin123' },
            { name: 'Admin', email: 'admin@paktaxadvisory.com', password: 'admin123' },
            { name: 'Test User', email: 'testuser@paktaxadvisor.com', password: 'TestUser123' }
        ];

        function fillTestAccount(account) {
            document.getElementById('email').value = account.email;
            document.getElementById('password').value = account.password;
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    authToken = data.sessionToken;
                    document.getElementById('loginStatus').innerHTML = `‚úÖ Logged in as: ${data.user.name} (${data.user.role})`;
                    document.getElementById('loginStatus').style.color = 'green';
                    
                    if (data.user.role === 'admin' || data.user.role === 'super_admin') {
                        document.getElementById('statsSection').style.display = 'grid';
                        document.getElementById('usersSection').style.display = 'block';
                        loadStats();
                        loadUsers();
                    }
                } else {
                    document.getElementById('loginStatus').innerHTML = `‚ùå Login failed: ${data.error}`;
                    document.getElementById('loginStatus').style.color = 'red';
                }
            } catch (error) {
                document.getElementById('loginStatus').innerHTML = `‚ùå Error: ${error.message}`;
                document.getElementById('loginStatus').style.color = 'red';
            }
        }

        function logout() {
            authToken = null;
            document.getElementById('loginStatus').innerHTML = 'üëã Logged out';
            document.getElementById('loginStatus').style.color = 'blue';
            document.getElementById('statsSection').style.display = 'none';
            document.getElementById('usersSection').style.display = 'none';
        }

        async function loadStats() {
            if (!authToken) return;
            
            try {
                const response = await fetch('/api/admin/stats', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const data = await response.json();
                
                if (data.success && data.data.users) {
                    document.getElementById('totalUsers').textContent = data.data.users.total_users || 0;
                    document.getElementById('activeUsers').textContent = data.data.users.active_users || 0;
                    document.getElementById('adminUsers').textContent = data.data.users.admin_users || 0;
                    document.getElementById('newUsers').textContent = data.data.users.new_users_30d || 0;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadUsers() {
            if (!authToken) return;
            
            try {
                const response = await fetch('/api/admin/users', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    allUsers = data.data;
                    renderUsers(allUsers);
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function renderUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';
            
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" class="user-checkbox checkbox" value="${user.id}" onchange="toggleUserSelection('${user.id}')"></td>
                    <td>
                        <strong>${user.name}</strong><br>
                        <small style="color: #666;">${user.email}</small>
                    </td>
                    <td>${user.user_type || 'individual'}</td>
                    <td><span class="role role-${user.role}">${user.role.replace('_', ' ').toUpperCase()}</span></td>
                    <td>
                        <span class="status status-${user.is_active ? 'active' : 'inactive'}" 
                              onclick="toggleUserStatus('${user.id}', ${user.is_active})" 
                              style="cursor: pointer;">
                            ${user.is_active ? 'ACTIVE' : 'INACTIVE'}
                        </span>
                    </td>
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-primary" onclick="editUser('${user.id}')">‚úèÔ∏è Edit</button>
                        ${user.role !== 'super_admin' ? `<button class="btn btn-danger" onclick="deleteUser('${user.id}')">üóëÔ∏è Delete</button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function filterUsers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const roleFilter = document.getElementById('roleFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            const filtered = allUsers.filter(user => {
                const matchesSearch = user.name.toLowerCase().includes(searchTerm) || 
                                    user.email.toLowerCase().includes(searchTerm);
                const matchesRole = roleFilter === 'all' || user.role === roleFilter;
                const matchesStatus = statusFilter === 'all' || 
                                    (statusFilter === 'active' && user.is_active) ||
                                    (statusFilter === 'inactive' && !user.is_active);
                
                return matchesSearch && matchesRole && matchesStatus;
            });
            
            renderUsers(filtered);
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.user-checkbox');
            
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
                const userId = cb.value;
                if (selectAll.checked && !selectedUsers.includes(userId)) {
                    selectedUsers.push(userId);
                } else if (!selectAll.checked) {
                    selectedUsers = selectedUsers.filter(id => id !== userId);
                }
            });
            
            updateBulkActions();
        }

        function toggleUserSelection(userId) {
            if (selectedUsers.includes(userId)) {
                selectedUsers = selectedUsers.filter(id => id !== userId);
            } else {
                selectedUsers.push(userId);
            }
            
            updateBulkActions();
        }

        function updateBulkActions() {
            const bulkBtn = document.getElementById('bulkDeleteBtn');
            if (selectedUsers.length > 0) {
                bulkBtn.style.display = 'inline-block';
                bulkBtn.textContent = `üóëÔ∏è Delete Selected (${selectedUsers.length})`;
            } else {
                bulkBtn.style.display = 'none';
            }
        }

        async function toggleUserStatus(userId, currentStatus) {
            if (!authToken) return;
            
            try {
                const response = await fetch(`/api/admin/users/${userId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ isActive: !currentStatus })
                });
                
                if (response.ok) {
                    loadUsers();
                    loadStats();
                }
            } catch (error) {
                console.error('Error updating user status:', error);
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user?')) return;
            
            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    loadUsers();
                    loadStats();
                }
            } catch (error) {
                console.error('Error deleting user:', error);
            }
        }

        async function bulkDelete() {
            if (selectedUsers.length === 0) return;
            if (!confirm(`Are you sure you want to delete ${selectedUsers.length} users?`)) return;
            
            try {
                await Promise.all(selectedUsers.map(userId => 
                    fetch(`/api/admin/users/${userId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    })
                ));
                
                selectedUsers = [];
                loadUsers();
                loadStats();
            } catch (error) {
                console.error('Error in bulk delete:', error);
            }
        }

        function showAddUserModal() {
            document.getElementById('addUserModal').style.display = 'block';
        }

        function closeAddUserModal() {
            document.getElementById('addUserModal').style.display = 'none';
            document.getElementById('addUserForm').reset();
        }

        document.getElementById('addUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('newName').value,
                email: document.getElementById('newEmail').value,
                password: document.getElementById('newPassword').value,
                role: document.getElementById('newRole').value,
                user_type: document.getElementById('newUserType').value
            };
            
            try {
                const response = await fetch('/api/admin/users', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    closeAddUserModal();
                    loadUsers();
                    loadStats();
                    alert('User created successfully!');
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.message}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        });

        function editUser(userId) {
            alert('Edit functionality would open an edit modal. Implementation similar to add user modal.');
        }

        // Quick login on page load for demo
        window.onload = function() {
            console.log('üáµüá∞ Pakistani Tax Advisor Admin Panel Test Ready!');
        }
    </script>
</body>
</html>