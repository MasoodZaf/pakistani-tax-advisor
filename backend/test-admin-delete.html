<!DOCTYPE html>
<html>
<head>
    <title>Test Admin Delete Function</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 10px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        input, select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .user-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .active {
            background: #d4edda;
            color: #155724;
        }
        .inactive {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>Admin Delete Function Test</h1>

    <div class="container">
        <h3>Admin Login</h3>
        <input type="email" id="email" placeholder="Email" value="super_admin@pakistanitaxadvisor.com">
        <input type="password" id="password" placeholder="Password" value="SuperAdmin123!">
        <button onclick="login()">Login as Super Admin</button>
        <div id="login-status"></div>
    </div>

    <div class="container">
        <h3>User Management</h3>
        <button onclick="fetchUsers()">Fetch All Users</button>
        <div id="users-list"></div>
    </div>

    <div class="container">
        <h3>Test Delete Function</h3>
        <input type="text" id="deleteUserId" placeholder="User ID to delete">
        <button onclick="testDeleteUser()" class="danger">Test Delete User</button>
        <div id="delete-result"></div>
    </div>

    <div class="container">
        <h3>Response Log</h3>
        <pre id="response-log"></pre>
    </div>

    <script>
        let authToken = '';
        const baseURL = 'http://localhost:3001';

        function log(message) {
            const logElement = document.getElementById('response-log');
            const timestamp = new Date().toISOString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${baseURL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                log(`Login Response: ${JSON.stringify(data, null, 2)}`);

                if (data.success && data.data.sessionToken) {
                    authToken = data.data.sessionToken;
                    document.getElementById('login-status').innerHTML =
                        `<span style="color: green;">✓ Logged in as ${data.data.user.name} (${data.data.user.role})</span>`;
                } else {
                    document.getElementById('login-status').innerHTML =
                        `<span style="color: red;">✗ Login failed</span>`;
                }
            } catch (error) {
                log(`Login Error: ${error.message}`);
                document.getElementById('login-status').innerHTML =
                    `<span style="color: red;">✗ Login error: ${error.message}</span>`;
            }
        }

        async function fetchUsers() {
            if (!authToken) {
                alert('Please login first');
                return;
            }

            try {
                const response = await fetch(`${baseURL}/api/admin/users`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const data = await response.json();
                log(`Fetch Users Response: ${JSON.stringify(data, null, 2)}`);

                if (data.success) {
                    displayUsers(data.data);
                } else {
                    document.getElementById('users-list').innerHTML =
                        `<span style="color: red;">Error: ${data.error}</span>`;
                }
            } catch (error) {
                log(`Fetch Users Error: ${error.message}`);
                document.getElementById('users-list').innerHTML =
                    `<span style="color: red;">Error: ${error.message}</span>`;
            }
        }

        function displayUsers(users) {
            const usersHTML = users.map(user => `
                <div class="user-row">
                    <div>
                        <strong>${user.name}</strong> (${user.email})<br>
                        <small>ID: ${user.id}</small><br>
                        <small>Role: ${user.role}</small>
                    </div>
                    <div>
                        <span class="status ${user.is_active ? 'active' : 'inactive'}">
                            ${user.is_active ? 'ACTIVE' : 'INACTIVE'}
                        </span>
                        <button onclick="deleteUser('${user.id}')" class="danger"
                                ${user.role === 'super_admin' ? 'disabled' : ''}>
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');

            document.getElementById('users-list').innerHTML = usersHTML;
        }

        async function deleteUser(userId) {
            if (!authToken) {
                alert('Please login first');
                return;
            }

            if (!confirm(`Are you sure you want to delete user ${userId}?`)) {
                return;
            }

            try {
                const response = await fetch(`${baseURL}/api/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const data = await response.json();
                log(`Delete User Response: ${JSON.stringify(data, null, 2)}`);

                if (data.success) {
                    alert(`User deleted successfully: ${data.message}`);
                    fetchUsers(); // Refresh users list
                } else {
                    alert(`Delete failed: ${data.error || data.message}`);
                }
            } catch (error) {
                log(`Delete User Error: ${error.message}`);
                alert(`Delete error: ${error.message}`);
            }
        }

        async function testDeleteUser() {
            const userId = document.getElementById('deleteUserId').value;
            if (!userId) {
                alert('Please enter a User ID');
                return;
            }

            await deleteUser(userId);
        }
    </script>
</body>
</html>