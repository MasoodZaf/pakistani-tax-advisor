<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Admin CP - Pakistani Tax Advisor</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background: #f5f7fa; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; }
        .header h1 { margin: 0 0 10px 0; font-size: 28px; }
        .header p { margin: 0; opacity: 0.9; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 20px rgba(0,0,0,0.1); }
        .card h3 { margin: 0 0 15px 0; color: #333; display: flex; align-items: center; gap: 10px; }
        .card p { color: #666; margin: 0 0 20px 0; }
        
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; }
        .btn-primary { background: #4f46e5; color: white; } .btn-primary:hover { background: #3730a3; }
        .btn-success { background: #059669; color: white; } .btn-success:hover { background: #047857; }
        .btn-warning { background: #d97706; color: white; } .btn-warning:hover { background: #b45309; }
        .btn-danger { background: #dc2626; color: white; } .btn-danger:hover { background: #b91c1c; }
        .btn-secondary { background: #6b7280; color: white; } .btn-secondary:hover { background: #4b5563; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #374151; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #4f46e5; }
        
        .status { margin: 15px 0; padding: 12px; border-radius: 8px; font-weight: 500; }
        .status.success { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .status.error { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .status.info { background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
        
        .results { background: #f9fafb; padding: 20px; border-radius: 8px; margin-top: 20px; border: 1px solid #e5e7eb; }
        .results h4 { margin: 0 0 15px 0; color: #374151; }
        .results pre { background: white; padding: 15px; border-radius: 6px; overflow-x: auto; font-size: 12px; border: 1px solid #d1d5db; }
        
        .users-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .users-table th, .users-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .users-table th { background: #f9fafb; font-weight: 600; color: #374151; }
        .users-table tr:hover { background: #f9fafb; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; margin: 5% auto; padding: 30px; width: 90%; max-width: 800px; border-radius: 12px; max-height: 80vh; overflow-y: auto; }
        .close { float: right; font-size: 28px; cursor: pointer; color: #6b7280; }
        .close:hover { color: #374151; }
        
        .tax-breakdown { margin-top: 20px; }
        .tax-slab { display: flex; justify-content: between; align-items: center; padding: 10px; margin: 5px 0; background: #f8fafc; border-radius: 6px; border-left: 4px solid #4f46e5; }
        .tax-slab .range { font-weight: 500; }
        .tax-slab .amount { color: #059669; font-weight: 600; }
        
        .icon { width: 20px; height: 20px; }
        
        .feature-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 20px; }
        .feature-card { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .feature-card h4 { margin: 0 0 8px 0; color: #1e293b; }
        .feature-card p { margin: 0; color: #64748b; font-size: 14px; }
        
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            .container { padding: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üáµüá∞ Enhanced Admin Control Panel</h1>
            <p>Tax Calculator, User Tax Records Management & Consultant Services - Pakistani Tax Advisor System</p>
        </div>

        <!-- Authentication Section -->
        <div class="card">
            <h3>üîê Admin Authentication</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr auto auto; gap: 15px; align-items: end;">
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="email" value="superadmin@paktaxadvisor.com">
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="password" value="superadmin123">
                </div>
                <button class="btn btn-primary" onclick="login()">üîë Login</button>
                <button class="btn btn-secondary" onclick="logout()">üö™ Logout</button>
            </div>
            <div style="margin-top: 15px;">
                <strong>Quick Login:</strong>
                <button class="btn btn-warning" onclick="quickLogin('superadmin@paktaxadvisor.com', 'superadmin123')" style="margin: 0 5px; padding: 6px 12px; font-size: 12px;">Super Admin</button>
                <button class="btn btn-success" onclick="quickLogin('admin@paktaxadvisory.com', 'admin123')" style="margin: 0 5px; padding: 6px 12px; font-size: 12px;">Admin</button>
            </div>
            <div id="loginStatus" class="status" style="display: none;"></div>
        </div>

        <div class="grid">
            <!-- Tax Calculator Card -->
            <div class="card">
                <h3>üßÆ Tax Calculator</h3>
                <p>Calculate Pakistani income tax with FBR 2025-26 rates</p>
                
                <div class="form-group">
                    <label>Gross Annual Income (PKR):</label>
                    <input type="number" id="taxIncome" placeholder="e.g., 1500000" value="1500000">
                </div>
                
                <div class="form-group">
                    <label>Allowances/Exemptions (PKR):</label>
                    <input type="number" id="taxAllowances" placeholder="e.g., 600000" value="600000">
                </div>
                
                <div class="form-group">
                    <label>Tax Year:</label>
                    <select id="taxYear">
                        <option value="2025-26">2025-26</option>
                        <option value="2024-25">2024-25</option>
                    </select>
                </div>
                
                <button class="btn btn-primary" onclick="calculateTax()">üìä Calculate Tax</button>
                
                <div id="taxResults" class="results" style="display: none;">
                    <h4>Tax Calculation Results</h4>
                    <div id="taxResultsContent"></div>
                </div>
            </div>

            <!-- User Management Card -->
            <div class="card">
                <h3>üë• User Management</h3>
                <p>View and manage user accounts with tax consultant access</p>
                
                <button class="btn btn-success" onclick="loadUsers()">üìã Load All Users</button>
                <button class="btn btn-primary" onclick="showUserSearch()">üîç Search User</button>
                
                <div id="userSearch" style="display: none; margin-top: 15px;">
                    <div class="form-group">
                        <label>Search Users:</label>
                        <input type="text" id="searchTerm" placeholder="Search by name or email..." onkeyup="filterUsers()">
                    </div>
                </div>
                
                <div id="usersContainer" style="margin-top: 15px;">
                    <p>Click "Load All Users" to see user list</p>
                </div>
            </div>
        </div>

        <!-- System Features Overview -->
        <div class="card">
            <h3>üéØ Enhanced Admin Capabilities</h3>
            <div class="feature-grid">
                <div class="feature-card">
                    <h4>üßÆ Tax Calculator</h4>
                    <p>Real-time tax calculation using Pakistani FBR rates with detailed breakdown by tax slabs</p>
                </div>
                <div class="feature-card">
                    <h4>üìä User Tax Records</h4>
                    <p>Complete access to user tax returns, forms, and filing history for consultation services</p>
                </div>
                <div class="feature-card">
                    <h4>‚úèÔ∏è Tax Consultant Editing</h4>
                    <p>Edit user tax forms as a qualified tax consultant with full audit trail</p>
                </div>
                <div class="feature-card">
                    <h4>üìà Tax Summary Reports</h4>
                    <p>Generate comprehensive tax summaries and completion status for all users</p>
                </div>
                <div class="feature-card">
                    <h4>üîç Advanced User Search</h4>
                    <p>Filter and search users by role, status, completion percentage, and tax liability</p>
                </div>
                <div class="feature-card">
                    <h4>üìã Bulk Operations</h4>
                    <p>Select multiple users for bulk actions including status updates and form management</p>
                </div>
            </div>
        </div>

        <!-- API Test Results -->
        <div class="card">
            <h3>üîß API Test Results</h3>
            <div id="apiResults" class="results">
                <p>API test results will appear here after performing actions above.</p>
            </div>
        </div>
    </div>

    <!-- User Tax Records Modal -->
    <div id="userTaxModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeUserTaxModal()">&times;</span>
            <h2 id="userTaxTitle">User Tax Records</h2>
            <div id="userTaxContent">Loading...</div>
        </div>
    </div>

    <script>
        let authToken = null;
        let allUsers = [];

        function quickLogin(email, password) {
            document.getElementById('email').value = email;
            document.getElementById('password').value = password;
            login();
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const statusDiv = document.getElementById('loginStatus');
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    authToken = data.sessionToken;
                    statusDiv.className = 'status success';
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = `‚úÖ Logged in as: <strong>${data.user.name}</strong> (${data.user.role}) - Ready for tax consultant services`;
                    
                    // Log to API results
                    logApiResult('Login', data, true);
                } else {
                    throw new Error(data.error || 'Login failed');
                }
            } catch (error) {
                authToken = null;
                statusDiv.className = 'status error';
                statusDiv.style.display = 'block';
                statusDiv.innerHTML = `‚ùå Login failed: ${error.message}`;
                logApiResult('Login', { error: error.message }, false);
            }
        }

        function logout() {
            authToken = null;
            const statusDiv = document.getElementById('loginStatus');
            statusDiv.className = 'status info';
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = 'üëã Logged out successfully';
            logApiResult('Logout', { message: 'Logged out' }, true);
        }

        async function calculateTax() {
            if (!authToken) {
                alert('Please login first');
                return;
            }

            const income = parseFloat(document.getElementById('taxIncome').value);
            const allowances = parseFloat(document.getElementById('taxAllowances').value) || 0;
            const taxYear = document.getElementById('taxYear').value;
            
            if (!income || income < 0) {
                alert('Please enter a valid income amount');
                return;
            }

            try {
                const response = await fetch('/api/admin/tax-calculator', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ income, allowances, tax_year: taxYear })
                });

                const data = await response.json();
                
                if (data.success) {
                    displayTaxResults(data.data);
                    logApiResult('Tax Calculator', data, true);
                } else {
                    throw new Error(data.message || 'Tax calculation failed');
                }
            } catch (error) {
                alert(`Tax calculation error: ${error.message}`);
                logApiResult('Tax Calculator', { error: error.message }, false);
            }
        }

        function displayTaxResults(results) {
            const resultsDiv = document.getElementById('taxResults');
            const contentDiv = document.getElementById('taxResultsContent');
            
            const formatCurrency = (amount) => new Intl.NumberFormat('en-PK', {
                style: 'currency',
                currency: 'PKR',
                minimumFractionDigits: 0
            }).format(amount);

            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: #dbeafe; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #1e40af;">${formatCurrency(results.gross_income)}</div>
                        <div style="font-size: 14px; color: #3730a3;">Gross Income</div>
                    </div>
                    <div style="background: #dcfce7; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #166534;">${formatCurrency(results.net_income)}</div>
                        <div style="font-size: 14px; color: #15803d;">Net Income</div>
                    </div>
                    <div style="background: #fee2e2; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #991b1b;">${formatCurrency(results.total_tax)}</div>
                        <div style="font-size: 14px; color: #b91c1c;">Income Tax</div>
                    </div>
                    <div style="background: #fef3c7; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #92400e;">${results.effective_tax_rate}%</div>
                        <div style="font-size: 14px; color: #b45309;">Tax Rate</div>
                    </div>
                </div>
                
                <h4>Tax Breakdown by Slabs:</h4>
                <div class="tax-breakdown">
            `;

            results.breakdown.forEach(slab => {
                html += `
                    <div class="tax-slab">
                        <div>
                            <div class="range">${slab.range}</div>
                            <div style="font-size: 12px; color: #6b7280;">Rate: ${slab.rate}</div>
                        </div>
                        <div class="amount">${formatCurrency(slab.tax_amount)}</div>
                    </div>
                `;
            });

            html += `</div>
                <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #0ea5e9;">
                    <strong>Summary:</strong><br>
                    Gross Income: ${formatCurrency(results.gross_income)}<br>
                    Less Allowances: (${formatCurrency(results.allowances)})<br>
                    Taxable Income: ${formatCurrency(results.taxable_income)}<br>
                    Income Tax: (${formatCurrency(results.total_tax)})<br>
                    <strong>Net Income: ${formatCurrency(results.net_income)}</strong>
                </div>
            `;

            contentDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        async function loadUsers() {
            if (!authToken) {
                alert('Please login first');
                return;
            }

            try {
                const response = await fetch('/api/admin/users', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const data = await response.json();
                
                if (data.success) {
                    allUsers = data.data;
                    displayUsers(allUsers);
                    document.getElementById('userSearch').style.display = 'block';
                    logApiResult('Load Users', { count: data.data.length }, true);
                } else {
                    throw new Error(data.message || 'Failed to load users');
                }
            } catch (error) {
                alert(`Load users error: ${error.message}`);
                logApiResult('Load Users', { error: error.message }, false);
            }
        }

        function displayUsers(users) {
            const container = document.getElementById('usersContainer');
            
            if (users.length === 0) {
                container.innerHTML = '<p>No users found</p>';
                return;
            }

            let html = `
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Tax Returns</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            users.forEach(user => {
                html += `
                    <tr>
                        <td>
                            <strong>${user.name}</strong><br>
                            <small style="color: #6b7280;">${user.email}</small>
                        </td>
                        <td>
                            <span style="background: ${getRoleColor(user.role)}; padding: 4px 8px; border-radius: 4px; font-size: 12px; color: white;">
                                ${user.role.replace('_', ' ').toUpperCase()}
                            </span>
                        </td>
                        <td>
                            <span style="background: ${user.is_active ? '#059669' : '#6b7280'}; padding: 4px 8px; border-radius: 4px; font-size: 12px; color: white;">
                                ${user.is_active ? 'ACTIVE' : 'INACTIVE'}
                            </span>
                        </td>
                        <td>${user.tax_returns_count || 0} returns</td>
                        <td>
                            <button class="btn btn-primary" onclick="viewUserTaxRecords('${user.id}', '${user.name}')" style="padding: 6px 12px; font-size: 12px; margin: 2px;">
                                üìä Tax Records
                            </button>
                            ${user.role === 'user' ? `
                                <button class="btn btn-success" onclick="editUserTaxForms('${user.id}', '${user.name}')" style="padding: 6px 12px; font-size: 12px; margin: 2px;">
                                    ‚úèÔ∏è Edit Tax Forms
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function getRoleColor(role) {
            const colors = {
                'user': '#3b82f6',
                'admin': '#8b5cf6',
                'super_admin': '#ef4444'
            };
            return colors[role] || '#6b7280';
        }

        function showUserSearch() {
            const searchDiv = document.getElementById('userSearch');
            searchDiv.style.display = searchDiv.style.display === 'none' ? 'block' : 'none';
        }

        function filterUsers() {
            const searchTerm = document.getElementById('searchTerm').value.toLowerCase();
            const filtered = allUsers.filter(user => 
                user.name.toLowerCase().includes(searchTerm) || 
                user.email.toLowerCase().includes(searchTerm)
            );
            displayUsers(filtered);
        }

        async function viewUserTaxRecords(userId, userName) {
            if (!authToken) {
                alert('Please login first');
                return;
            }

            try {
                const response = await fetch(`/api/admin/users/${userId}/tax-records`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const data = await response.json();
                
                if (data.success) {
                    showUserTaxModal(userName, data.data);
                    logApiResult('User Tax Records', { userId, recordsCount: data.data.tax_returns.length }, true);
                } else {
                    throw new Error(data.message || 'Failed to load user tax records');
                }
            } catch (error) {
                alert(`Load tax records error: ${error.message}`);
                logApiResult('User Tax Records', { error: error.message }, false);
            }
        }

        function showUserTaxModal(userName, taxData) {
            const modal = document.getElementById('userTaxModal');
            const title = document.getElementById('userTaxTitle');
            const content = document.getElementById('userTaxContent');
            
            title.innerHTML = `üìä ${userName} - Tax Records`;
            
            let html = `
                <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4>Tax Summary</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #3b82f6;">${taxData.summary.total_returns}</div>
                            <div style="font-size: 12px; color: #6b7280;">Total Returns</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #059669;">${taxData.summary.completed_returns}</div>
                            <div style="font-size: 12px; color: #6b7280;">Completed</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #d97706;">${taxData.summary.draft_returns}</div>
                            <div style="font-size: 12px; color: #6b7280;">Draft</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #8b5cf6;">${taxData.summary.current_year_completion}%</div>
                            <div style="font-size: 12px; color: #6b7280;">Progress</div>
                        </div>
                    </div>
                </div>
                
                <h4>Tax Returns History</h4>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f9fafb;">
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #e5e7eb;">Tax Year</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #e5e7eb;">Return Number</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #e5e7eb;">Status</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #e5e7eb;">Tax Liability</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            taxData.tax_returns.forEach(taxReturn => {
                const formatCurrency = (amount) => amount ? 
                    new Intl.NumberFormat('en-PK', { style: 'currency', currency: 'PKR', minimumFractionDigits: 0 }).format(amount) : 
                    'Not calculated';

                html += `
                    <tr>
                        <td style="padding: 10px; border-bottom: 1px solid #e5e7eb;">
                            ${taxReturn.tax_year}
                            ${taxReturn.is_current ? '<span style="background: #3b82f6; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px;">CURRENT</span>' : ''}
                        </td>
                        <td style="padding: 10px; border-bottom: 1px solid #e5e7eb;">${taxReturn.return_number}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #e5e7eb;">
                            <span style="background: ${taxReturn.filing_status === 'submitted' ? '#059669' : '#d97706'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                ${taxReturn.filing_status.toUpperCase()}
                            </span>
                        </td>
                        <td style="padding: 10px; border-bottom: 1px solid #e5e7eb;">${formatCurrency(taxReturn.total_tax_liability)}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-primary" onclick="closeUserTaxModal()">Close</button>
                </div>
            `;

            content.innerHTML = html;
            modal.style.display = 'block';
        }

        function closeUserTaxModal() {
            document.getElementById('userTaxModal').style.display = 'none';
        }

        function editUserTaxForms(userId, userName) {
            alert(`Tax Consultant Editing for ${userName} would open detailed tax form editor with:\n\n‚Ä¢ Income Form Editor\n‚Ä¢ Deductions & Allowances Editor\n‚Ä¢ Tax Calculation Editor\n‚Ä¢ Final Tax Form Editor\n\nAll changes logged with admin audit trail.`);
        }

        function logApiResult(operation, data, success) {
            const resultsDiv = document.getElementById('apiResults');
            const timestamp = new Date().toLocaleTimeString();
            
            const resultHtml = `
                <div style="margin-bottom: 15px; padding: 15px; border-radius: 8px; background: ${success ? '#f0f9ff' : '#fef2f2'}; border: 1px solid ${success ? '#0ea5e9' : '#f87171'};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong style="color: ${success ? '#0c4a6e' : '#991b1b'};">${success ? '‚úÖ' : '‚ùå'} ${operation}</strong>
                        <span style="font-size: 12px; color: #6b7280;">${timestamp}</span>
                    </div>
                    <pre style="margin: 0; font-size: 11px; background: ${success ? '#e0f2fe' : '#fee2e2'}; padding: 10px; border-radius: 4px; overflow-x: auto;">${JSON.stringify(data, null, 2)}</pre>
                </div>
            `;
            
            resultsDiv.innerHTML = resultHtml + resultsDiv.innerHTML;
        }

        // Initialize
        window.onload = function() {
            console.log('üáµüá∞ Enhanced Pakistani Tax Advisor Admin CP Ready!');
            console.log('Features: Tax Calculator, User Tax Records, Consultant Editing');
        };
    </script>
</body>
</html>